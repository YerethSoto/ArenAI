import React, { useState, useMemo } from "react";
import {
  IonContent,
  IonPage,
  IonIcon,
  IonHeader,
  IonToolbar,
  IonMenuButton,
  IonRange,
  IonTextarea,
  IonButton,
  IonModal,
  IonSearchbar,
  IonLoading,
  useIonToast,
} from "@ionic/react";
import {
  menu,
  addCircleOutline,
  closeOutline,
  createOutline,
} from "ionicons/icons";
import { useTranslation } from "react-i18next";
import { useHistory } from "react-router-dom";
import { getApiUrl } from "../config/api";
import "./AIQuizGenerator.css";
import "../components/StudentHeader.css";
import PageTransition from "../components/PageTransition";

// All Available Topics
const ALL_TOPICS: { key: string; name: string; subject: string }[] = [
  { key: "Algebra", name: "Algebra", subject: "Math" },
  { key: "Geometry", name: "Geometry", subject: "Math" },
  { key: "Calculus", name: "Calculus", subject: "Math" },
  { key: "Statistics", name: "Statistics", subject: "Math" },
  { key: "Trigonometry", name: "Trigonometry", subject: "Math" },
  { key: "Probability", name: "Probability", subject: "Math" },
  { key: "LinearEquations", name: "Linear Equations", subject: "Math" },
  { key: "Fractions", name: "Fractions", subject: "Math" },
  { key: "Biology", name: "Biology", subject: "Science" },
  { key: "Chemistry", name: "Chemistry", subject: "Science" },
  { key: "Physics", name: "Physics", subject: "Science" },
  { key: "EarthScience", name: "Earth Science", subject: "Science" },
  { key: "Astronomy", name: "Astronomy", subject: "Science" },
  { key: "Genetics", name: "Genetics", subject: "Science" },
  { key: "History", name: "History", subject: "Social Studies" },
  { key: "Geography", name: "Geography", subject: "Social Studies" },
  { key: "Civics", name: "Civics", subject: "Social Studies" },
  { key: "Economics", name: "Economics", subject: "Social Studies" },
  { key: "Vocabulary", name: "Vocabulary", subject: "Spanish" },
  { key: "Grammar", name: "Grammar", subject: "Spanish" },
  { key: "Reading", name: "Reading", subject: "Spanish" },
  { key: "Writing", name: "Writing", subject: "Spanish" },
];

const SUBJECTS = ["Math", "Science", "Social Studies", "Spanish"];

const AIQuizGenerator: React.FC = () => {
  const { t, i18n } = useTranslation();
  const [present] = useIonToast();
  const history = useHistory();

  // Loading state for AI generation
  const [isLoading, setIsLoading] = useState(false);

  const [selectedSubject, setSelectedSubject] = useState("Math");
  const [selectedTopics, setSelectedTopics] = useState<string[]>([]);
  const [addedTopics, setAddedTopics] = useState<
    { key: string; name: string; subject: string }[]
  >([]);
  const [questionCount, setQuestionCount] = useState(5);
  const [customPrompt, setCustomPrompt] = useState("");
  const [showTopicModal, setShowTopicModal] = useState(false);
  const [showSubjectDropdown, setShowSubjectDropdown] = useState(false);
  const [searchText, setSearchText] = useState("");
  const [modalSelectedTopics, setModalSelectedTopics] = useState<string[]>([]);

  // Quiz Name State
  const [quizName, setQuizName] = useState("Quiz de sumas");
  const [showNameModal, setShowNameModal] = useState(false);
  const [tempName, setTempName] = useState("");

  // Question Count Modal
  const [showCountModal, setShowCountModal] = useState(false);
  const [tempCount, setTempCount] = useState("");

  // Grade Level State
  const [gradeLevel, setGradeLevel] = useState(5);
  const [showGradeModal, setShowGradeModal] = useState(false);
  const [tempGrade, setTempGrade] = useState("");

  // Default topics for the current subject
  const defaultTopics = useMemo(() => {
    return ALL_TOPICS.filter((t) => t.subject === selectedSubject).slice(0, 3);
  }, [selectedSubject]);

  // All displayed topics
  const displayedTopics = useMemo(() => {
    const result = [...defaultTopics];
    addedTopics.forEach((topic) => {
      if (!result.find((t) => t.key === topic.key)) {
        result.push(topic);
      }
    });
    return result;
  }, [defaultTopics, addedTopics]);

  // Search filtered topics
  const searchResults = useMemo(() => {
    if (!searchText.trim()) return ALL_TOPICS;
    const query = searchText.toLowerCase();
    return ALL_TOPICS.filter(
      (t) =>
        t.name.toLowerCase().includes(query) ||
        t.subject.toLowerCase().includes(query)
    );
  }, [searchText]);

  const toggleTopic = (topicKey: string) => {
    setSelectedTopics((prev) =>
      prev.includes(topicKey)
        ? prev.filter((t) => t !== topicKey)
        : [...prev, topicKey]
    );
  };

  const toggleModalTopic = (topicKey: string) => {
    setModalSelectedTopics((prev) =>
      prev.includes(topicKey)
        ? prev.filter((t) => t !== topicKey)
        : [...prev, topicKey]
    );
  };

  const handleAddTopicsFromModal = () => {
    const newTopics = ALL_TOPICS.filter((t) =>
      modalSelectedTopics.includes(t.key)
    );
    setAddedTopics((prev) => {
      const existingKeys = prev.map((t) => t.key);
      const toAdd = newTopics.filter((t) => !existingKeys.includes(t.key));
      return [...prev, ...toAdd];
    });
    setSelectedTopics((prev) => [
      ...new Set([...prev, ...modalSelectedTopics]),
    ]);
    setModalSelectedTopics([]);
    setSearchText("");
    setShowTopicModal(false);
  };

  const handleSubjectChange = (subject: string) => {
    setSelectedSubject(subject);
    setSelectedTopics([]);
    setAddedTopics([]);
    setShowSubjectDropdown(false);
  };

  const handleGenerateQuiz = async () => {
    if (selectedTopics.length === 0) {
      present({
        message: "Please select at least one topic",
        duration: 2000,
        color: "danger",
      });
      return;
    }

    setIsLoading(true);

    try {
      // Get language from i18n or default to Spanish
      const language =
        i18n.language === "en"
          ? "English"
          : i18n.language === "zh"
          ? "Chinese"
          : "Spanish";

      console.log("Generating Quiz with AI...", {
        subject: selectedSubject,
        topics: selectedTopics,
        questionCount,
        gradeLevel,
        language,
        customPrompt,
      });

      const response = await fetch(getApiUrl("/ai/generate-quiz"), {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({
          subject: selectedSubject,
          level: gradeLevel,
          topics: selectedTopics,
          questionCount,
          language,
          customPrompt: customPrompt || undefined,
        }),
      });

      if (!response.ok) {
        const errorData = await response.json().catch(() => ({}));
        throw new Error(errorData.message || "Failed to generate quiz");
      }

      const result = await response.json();

      if (!result.success || !result.data?.questions) {
        throw new Error("Invalid response from AI");
      }

      console.log("Quiz generated successfully:", result.data);

      // Store generated quiz data in sessionStorage for preview page
      sessionStorage.setItem(
        "generatedQuiz",
        JSON.stringify({
          quizName,
          subject: selectedSubject,
          gradeLevel,
          questions: result.data.questions,
        })
      );

      present({
        message: `Generated ${result.data.questions.length} questions!`,
        duration: 1500,
        color: "success",
      });

      // Navigate to preview page
      history.push("/page/quiz-preview");
    } catch (error: any) {
      console.error("Error generating quiz:", error);
      present({
        message: error.message || "Failed to generate quiz. Please try again.",
        duration: 3000,
        color: "danger",
      });
    } finally {
      setIsLoading(false);
    }
  };

  const openModal = () => {
    setModalSelectedTopics([]);
    setSearchText("");
    setShowTopicModal(true);
  };

  // Name Modal Handlers (like ArenEntity)
  const openNameModal = () => {
    setTempName(quizName);
    setShowNameModal(true);
  };

  const saveQuizName = () => {
    if (tempName.trim()) {
      setQuizName(tempName.trim());
    }
    setShowNameModal(false);
  };

  // Question count modal handlers
  const openCountModal = () => {
    setTempCount(String(questionCount));
    setShowCountModal(true);
  };

  const saveQuestionCount = () => {
    const value = parseInt(tempCount, 10);
    if (!isNaN(value) && value >= 5 && value <= 100) {
      setQuestionCount(value);
    }
    setShowCountModal(false);
  };

  return (
    <IonPage className="ai-quiz-page">
      {/* Loading Overlay */}
      <IonLoading
        isOpen={isLoading}
        message="Generating quiz with AI..."
        spinner="crescent"
      />

      {/* Header */}
      <IonHeader className="student-header-container">
        <IonToolbar className="student-toolbar">
          <div className="sh-content">
            <div className="sh-menu-btn-container">
              <IonMenuButton className="sh-menu-btn">
                <IonIcon icon={menu} />
              </IonMenuButton>
            </div>
          </div>
        </IonToolbar>

        <div className="sh-brand-container-absolute">
          <div className="sh-brand-name">ArenAI</div>
          <div className="sh-brand-sub">Generator</div>
        </div>

        <div className="sh-notch-container">
          <div className="sh-notch">
            <div
              className="sh-subject-display interactive"
              onClick={(e) => {
                e.stopPropagation();
                setShowSubjectDropdown(!showSubjectDropdown);
              }}
              style={{ pointerEvents: "auto", cursor: "pointer" }}
            >
              <span className="sh-subject-text">
                {t(
                  `professor.dashboard.subjects.${selectedSubject.replace(
                    /\s+/g,
                    ""
                  )}`
                ) || selectedSubject}
              </span>
            </div>
          </div>
        </div>

        {showSubjectDropdown && (
          <div className="quiz-subject-dropdown">
            {SUBJECTS.map((subj) => (
              <div
                key={subj}
                onClick={(e) => {
                  e.stopPropagation();
                  handleSubjectChange(subj);
                }}
                className={`quiz-subject-option ${
                  selectedSubject === subj ? "selected" : ""
                }`}
              >
                {t(
                  `professor.dashboard.subjects.${subj.replace(/\s+/g, "")}`
                ) || subj}
              </div>
            ))}
          </div>
        )}
      </IonHeader>

      <IonContent
        className="ai-quiz-content"
        fullscreen
        onClick={() => showSubjectDropdown && setShowSubjectDropdown(false)}
      >
        <PageTransition variant="fade">
          <div className="quiz-container">
            {/* Quiz Name with Floral Separator */}
            <div className="quiz-name-section">
              <div className="quiz-name-display" onClick={openNameModal}>
                <span>{quizName}</span>
                <IonIcon icon={createOutline} className="quiz-name-edit-icon" />
              </div>
              <div className="floral-separator">
                <div className="floral-line"></div>
                <div className="floral-center">‚ùß</div>
                <div className="floral-line"></div>
              </div>
            </div>

            {/* Quiz Topics Card */}
            <div className="quiz-card">
              <div className="quiz-card-title">Quiz Topics</div>

              <div className="quiz-topics-grid">
                {displayedTopics.map((topic) => (
                  <div
                    key={topic.key}
                    className={`quiz-topic-item ${
                      selectedTopics.includes(topic.key) ? "selected" : ""
                    }`}
                    onClick={() => toggleTopic(topic.key)}
                  >
                    <div className="quiz-topic-checkbox">
                      {selectedTopics.includes(topic.key) && (
                        <div className="quiz-topic-checkmark"></div>
                      )}
                    </div>
                    <span className="quiz-topic-name">{topic.name}</span>
                  </div>
                ))}
              </div>

              {/* Add More Button - Half in / Half out */}
              <div className="quiz-add-more-container">
                <div className="quiz-add-more-btn" onClick={openModal}>
                  <IonIcon icon={addCircleOutline} />
                  <span>Add More</span>
                </div>
              </div>
            </div>

            {/* Advanced Settings Card */}
            <div className="quiz-card">
              <div className="quiz-card-title">Advanced settings</div>

              {/* Questions Row - Click to open modal */}
              <div className="quiz-questions-row" onClick={openCountModal}>
                <div className="quiz-question-circle">
                  <span className="quiz-question-number">{questionCount}</span>
                </div>
                <span className="quiz-questions-label">Questions</span>
              </div>

              {/* Slider - max 30, show 30+ if count > 30 */}
              <div className="quiz-slider-container">
                <div className="quiz-slider-row">
                  <span className="quiz-slider-label">5</span>
                  <IonRange
                    min={5}
                    max={30}
                    step={1}
                    value={Math.min(questionCount, 30)}
                    onIonChange={(e) => {
                      const val = e.detail.value as number;
                      if (val <= 30) setQuestionCount(val);
                    }}
                    color="secondary"
                    style={{ flex: 1 }}
                  />
                  <span className="quiz-slider-label">
                    {questionCount > 30 ? "30+" : "30"}
                  </span>
                </div>
              </div>

              {/* Grade Level Row - Click to open modal */}
              <div
                className="quiz-questions-row"
                onClick={() => {
                  setTempGrade(String(gradeLevel));
                  setShowGradeModal(true);
                }}
              >
                <div className="quiz-question-circle">
                  <span className="quiz-question-number">{gradeLevel}</span>
                </div>
                <span className="quiz-questions-label">Grade Level</span>
              </div>

              {/* Additional Details */}
              <div className="quiz-details-section">
                <span className="quiz-details-label">Additional details</span>
                <IonTextarea
                  className="quiz-details-textarea"
                  rows={3}
                  value={customPrompt}
                  onIonChange={(e) => setCustomPrompt(e.detail.value!)}
                  placeholder="Add specific instructions for the AI..."
                />
              </div>
            </div>

            {/* Spacer so content doesn't get hidden by footer */}
            <div className="quiz-footer-spacer"></div>
          </div>
        </PageTransition>
      </IonContent>

      {/* Footer - Like Professor Header (Inverted) */}
      <div className="quiz-footer">
        <div className="quiz-footer-notch">
          <div className="quiz-generate-btn" onClick={handleGenerateQuiz}>
            Generate
          </div>
        </div>
      </div>

      {/* Quiz Name Modal - Like ArenEntity */}
      <IonModal
        isOpen={showNameModal}
        onDidDismiss={() => setShowNameModal(false)}
        className="quiz-name-modal"
      >
        <div className="quiz-modal-inner">
          <h2 className="quiz-modal-title">{t("Quiz Name")}</h2>

          <div className="quiz-input-wrapper">
            <input
              type="text"
              className="quiz-modal-input-field"
              value={tempName}
              onChange={(e) => setTempName(e.target.value)}
              placeholder="Enter quiz name"
            />
          </div>

          <div className="quiz-modal-buttons">
            <button
              className="quiz-modal-btn cancel"
              onClick={() => setShowNameModal(false)}
            >
              {t("common.cancel") || "Cancel"}
            </button>
            <button className="quiz-modal-btn save" onClick={saveQuizName}>
              {t("common.save") || "Save"}
            </button>
          </div>
        </div>
      </IonModal>

      {/* Question Count Modal */}
      <IonModal
        isOpen={showCountModal}
        onDidDismiss={() => setShowCountModal(false)}
        className="quiz-name-modal"
      >
        <div className="quiz-modal-inner">
          <h2 className="quiz-modal-title">Number of Questions</h2>

          <div className="quiz-input-wrapper">
            <input
              type="number"
              className="quiz-modal-input-field"
              value={tempCount}
              onChange={(e) => setTempCount(e.target.value)}
              placeholder="5-100"
              min={5}
              max={100}
            />
          </div>
          <p className="quiz-modal-hint">Enter a number between 5 and 100</p>

          <div className="quiz-modal-buttons">
            <button
              className="quiz-modal-btn cancel"
              onClick={() => setShowCountModal(false)}
            >
              {t("common.cancel") || "Cancel"}
            </button>
            <button className="quiz-modal-btn save" onClick={saveQuestionCount}>
              {t("common.save") || "Save"}
            </button>
          </div>
        </div>
      </IonModal>

      {/* Grade Level Modal */}
      <IonModal
        isOpen={showGradeModal}
        onDidDismiss={() => setShowGradeModal(false)}
        className="quiz-name-modal"
      >
        <div className="quiz-modal-inner">
          <h2 className="quiz-modal-title">Grade Level</h2>

          <div className="quiz-input-wrapper">
            <input
              type="number"
              className="quiz-modal-input-field"
              value={tempGrade}
              onChange={(e) => setTempGrade(e.target.value)}
              placeholder="1-12"
              min={1}
              max={12}
            />
          </div>
          <p className="quiz-modal-hint">Select grade 1st to 12th</p>

          <div className="quiz-modal-buttons">
            <button
              className="quiz-modal-btn cancel"
              onClick={() => setShowGradeModal(false)}
            >
              {t("common.cancel") || "Cancel"}
            </button>
            <button
              className="quiz-modal-btn save"
              onClick={() => {
                const value = parseInt(tempGrade, 10);
                if (!isNaN(value) && value >= 1 && value <= 12) {
                  setGradeLevel(value);
                }
                setShowGradeModal(false);
              }}
            >
              {t("common.save") || "Save"}
            </button>
          </div>
        </div>
      </IonModal>

      {/* Add Topic Modal */}
      <IonModal
        isOpen={showTopicModal}
        onDidDismiss={() => setShowTopicModal(false)}
        className="quiz-topic-modal"
      >
        <div className="quiz-modal-header">
          <h3>Search Topics</h3>
          <IonIcon
            icon={closeOutline}
            style={{
              fontSize: "28px",
              cursor: "pointer",
              color: "var(--ion-color-primary)",
            }}
            onClick={() => setShowTopicModal(false)}
          />
        </div>

        <div className="quiz-modal-search">
          <IonSearchbar
            value={searchText}
            onIonInput={(e) => setSearchText(e.detail.value || "")}
            placeholder="Search for topics..."
            debounce={200}
            className="quiz-searchbar"
          />
        </div>

        <div className="quiz-modal-content">
          <div className="quiz-modal-grid">
            {searchResults.map((topic) => (
              <div
                key={topic.key}
                className={`quiz-topic-item ${
                  modalSelectedTopics.includes(topic.key) ? "selected" : ""
                }`}
                onClick={() => toggleModalTopic(topic.key)}
              >
                <div className="quiz-topic-checkbox">
                  {modalSelectedTopics.includes(topic.key) && (
                    <div className="quiz-topic-checkmark"></div>
                  )}
                </div>
                <div className="quiz-topic-info">
                  <span className="quiz-topic-name">{topic.name}</span>
                  <span className="quiz-topic-subject">{topic.subject}</span>
                </div>
              </div>
            ))}
          </div>
        </div>

        <div className="quiz-modal-footer">
          <IonButton
            expand="block"
            className="quiz-modal-add-btn"
            onClick={handleAddTopicsFromModal}
            disabled={modalSelectedTopics.length === 0}
          >
            Add{" "}
            {modalSelectedTopics.length > 0
              ? `(${modalSelectedTopics.length})`
              : ""}{" "}
            Topics
          </IonButton>
        </div>
      </IonModal>
    </IonPage>
  );
};

export default AIQuizGenerator;
